<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理店鋪</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-4">
    <!-- Header with Username and Logout -->
    <div class="flex justify-between items-center mb-6">
	<a href="/admin"class="bg-blue-500 text-white p-4 rounded text-center hover:bg-blue-600">← 後退</a>
      <h1 class="text-3xl font-bold">店鋪管理</h1>
      <div class="flex items-center space-x-4">
        <span id="username" class="text-lg font-semibold"></span>
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">登出賬戶</button>
      </div>
    </div>


    <!-- Shop Form -->
    <div class="bg-white p-6 rounded shadow-md mb-8">
      <h2 id="form-title" class="text-2xl font-semibold mb-4">新增店鋪</h2>
      <input id="shop-id" type="hidden">

      <input id="shop-name" type="text" placeholder="Name" class="w-full p-2 mb-2 border rounded" required>
      <input id="shop-region" type="text" placeholder="Region" class="w-full p-2 mb-2 border rounded" required>
      <input id="shop-district" type="text" placeholder="District" class="w-full p-2 mb-2 border rounded" required>
      <input id="shop-address" type="text" placeholder="Address" class="w-full p-2 mb-2 border rounded" required>
      <input id="shop-latitude" type="number" placeholder="Latitude" class="w-full p-2 mb-2 border rounded" required>
      <input id="shop-longitude" type="number" placeholder="Longitude" class="w-full p-2 mb-2 border rounded" required>
      <input id="shop-phone" type="text" placeholder="Phone" class="w-full p-2 mb-2 border rounded" required>
      <input id="shop-openhours" type="text" placeholder="opening_hours" class="w-full p-2 mb-2 border rounded" required>
      <div class="flex space-x-4">
        <button id="btn-create" onclick="createProduct()"
          class="flex-1 bg-green-500 text-white p-2 rounded hover:bg-green-600">建立</button>
        <button id="btn-update" onclick="updateProduct()"
          class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 hidden">確認修改</button>
        <button onclick="cancelEdit()" class="flex-1 bg-gray-400 text-white p-2 rounded hover:bg-gray-500">取消</button>
      </div>
    </div>

    <!-- Search and Shop List -->
    <div class="mb-8">
      <h2 class="text-2xl font-semibold mb-4">列表</h2>
      <input id="shop-search" type="text" placeholder="請輸入想搜尋的關鍵字" class="w-full p-2 mb-4 border rounded" oninput="searchItems()">
      <div id="shop-list" class="mt-4"></div>
    </div>
  </div>

  <script>
    const collection = 'shop';
    let token = localStorage.getItem('token');
    let allItems = []; // Store all fetched items

    // Redirect to login if no token
    if (!token) {
      window.location.href = '/admin';
    }

    // JWT decode function
    function jwtDecode(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return {};
      }
    }

    // Logout function
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/admin';
    }

    // Display username
    function displayUsername() {
      const decoded = jwtDecode(token);
      const usernameElement = document.getElementById('username');
      usernameElement.textContent = decoded.username || 'User';
    }
    /* ---------- 模式切換 ---------- */
    function setCreateMode() {
      document.getElementById('form-title').textContent = '新增店鋪';
      document.getElementById('btn-create').classList.remove('hidden');
      document.getElementById('btn-update').classList.add('hidden');
      document.getElementById('shop-id').value = '';
      document.querySelectorAll('#shop-name, #shop-region, #shop-district, #shop-address, #shop-latitude, #shop-longitude, #shop-phone,#shop-openhours')
        .forEach(el => el.value = '');
    }
    function setEditMode(item) {
      document.getElementById('form-title').textContent = '修改店鋪';
      document.getElementById('btn-create').classList.add('hidden');
      document.getElementById('btn-update').classList.remove('hidden');
      document.getElementById('shop-id').value = item._id;
      document.getElementById('shop-name').value = item.name;
      document.getElementById('shop-region').value = item.region;
      document.getElementById('shop-district').value = item.district;
      document.getElementById('shop-address').value = item.address;
      document.getElementById('shop-latitude').value = item.latitude;
      document.getElementById('shop-longitude').value = item.longitude;
      document.getElementById('shop-phone').value = item.phone;
      document.getElementById('shop-openhours').value = item.opening_hours;
    }
    function cancelEdit() { setCreateMode(); }
	
    // Load data
    async function loadData() {
      try {
        const response = await fetch(`/${collection}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.status === 401) {
          window.location.href = '/admin';
          return;
        }
        allItems = await response.json();
        renderItems(allItems);
      } catch (error) {
        console.error(`Error loading ${collection}:`, error);
        window.location.href = '/admin';
      }
    }

    // Render items (limited to 15, filtered by search)
    function renderItems(items) {
      const searchQuery = document.getElementById(`${collection}-search`).value.toLowerCase();
      const filteredItems = items.filter(item => 
        item.name && item.name.toLowerCase().includes(searchQuery)
      )
      const list = document.getElementById(`${collection}-list`);
      list.innerHTML = '';
      filteredItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'bg-white p-4 mb-2 rounded shadow flex justify-between';
        div.innerHTML = `
          <span>${item.name}</span>
          <div>
            <button onclick="editItem('${item._id}')" class="bg-yellow-500 text-white px-2 py-1 rounded mr-2">修改</button>
            <button onclick="if(confirm('確定要刪除這一項嗎？')) deleteItem('${item._id}')" class="bg-red-500 text-white px-2 py-1 rounded">刪除</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    // Search items
    function searchItems() {
      renderItems(allItems);
    }

    // Edit item
    async function editItem(id) {
      try {
        const item = allItems.find(i => i._id === id);
        if (item) {
          setEditMode(item);
          document.getElementById(`${collection}-id`).value = id;
          Object.keys(item).forEach(key => {
            if (key !== '_id') {
              const input = document.getElementById(`${collection}-${key}`);
              if (input) 
                input.value = item[key];
            }
          });
        }
      } catch (error) {
        console.error(`Error editing ${collection}:`, error);
      }
    }

    // Delete item
    async function deleteItem(id) {
	
      try {
        const response = await fetch(`/${collection}/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
		
        if (response.status === 200) {
          alert(`${collection} 刪除完畢`);
          loadData();
        } else {
          alert(`刪除錯誤 ${collection}`);
        }
      } catch (error) {
        console.error(`Error deleting ${collection}:`, error);
      }
    }

 /* ---------- 表單處理 ---------- */
    function getFormData() {
      return {
        name: document.getElementById('shop-name').value.trim(),
        region: document.getElementById('shop-region').value.trim(),
        district: document.getElementById('shop-district').value.trim(),
        address: document.getElementById('shop-address').value.trim(),
        latitude: Number(document.getElementById('shop-latitude').value),
        longitude: Number(document.getElementById('shop-longitude').value),
        phone: document.getElementById('shop-phone').value.trim(),
        opening_hours: document.getElementById('shop-openhours').value.trim()
      };
    }
    function validateForm() {
      const data = getFormData();
      const ok = Object.values(data).every(v => v !== '' && !Number.isNaN(v));
      if (!ok) alert('請填寫所有必填欄位');
      return ok;
    }
    async function createProduct() {
      if (!validateForm()) return;
      await saveItem(null, getFormData());
      setCreateMode();
    }
    async function updateProduct() {
      const id = document.getElementById('shop-id').value;
      if (!id || !validateForm()) return;
      await saveItem(id, getFormData());
      setCreateMode();
    }


    // Generic save function
    async function saveItem(id, data) {
      try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/${collection}/${id}` : `/${collection}`;
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        // console.log(response.status)
        if (response.status === 201 || response.status === 200) {
          alert(`${collection} ${id ? '資料已更新' : '資料已建立'} `);
          loadData();
          document.querySelectorAll(`#${collection}-form input, #${collection}-form textarea`).forEach(input => input.value = '');
          document.getElementById(`${collection}-id`).value = '';
        } else {
          alert(`錯誤的 ${id ? '更新' : '建立'} ${collection}`);
        }
      } catch (error) {
        console.error(`Error saving ${collection}:`, error);
      }
    }

    // Load data and username on page load
    window.onload = () => {
      displayUsername();
      loadData();
    };
  </script>
</body>
</html>