<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>管理物品</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-4">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <a href="/admin" class="bg-blue-500 text-white p-4 rounded text-center hover:bg-blue-600">← 後退</a>
      <h1 class="text-3xl font-bold">物品管理</h1>
      <div class="flex items-center space-x-4">
        <span id="username" class="text-lg font-semibold"></span>
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">登出賬戶</button>
      </div>
    </div>

    <!-- Product Form -->
    <div class="bg-white p-6 rounded shadow-md mb-8">
      <h2 id="form-title" class="text-2xl font-semibold mb-4">新增物品</h2>
      <input id="product-id" type="hidden" />
      <input id="product-name" type="text" placeholder="Name" class="w-full p-2 mb-2 border rounded" required />
      <input id="product-brand" type="text" placeholder="Brand" class="w-full p-2 mb-2 border rounded" required />
      <input id="product-model" type="text" placeholder="Model" class="w-full p-2 mb-2 border rounded" required />
      <textarea id="product-description" placeholder="Description" class="w-full p-2 mb-2 border rounded"
        required></textarea>
      <input id="product-price_hkd" type="number" placeholder="Price (HKD)" class="w-full p-2 mb-2 border rounded"
        required />
      <input id="product-category_type" type="number" placeholder="Category Type" class="w-full p-2 mb-2 border rounded"
        required />
      <input id="product-hot" type="number" placeholder="Hot" class="w-full p-2 mb-2 border rounded" required />

      <div class="flex space-x-4">
        <button id="btn-create" onclick="createProduct()"
          class="flex-1 bg-green-500 text-white p-2 rounded hover:bg-green-600">建立</button>
        <button id="btn-update" onclick="updateProduct()"
          class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 hidden">確認修改</button>
        <button onclick="cancelEdit()" class="flex-1 bg-gray-400 text-white p-2 rounded hover:bg-gray-500">取消</button>
      </div>
    </div>

    <!-- Search and Product List -->
    <div class="mb-8">
      <h2 class="text-2xl font-semibold mb-4">列表</h2>
      <input id="product-search" type="text" placeholder="請輸入想搜尋的關鍵字" class="w-full p-2 mb-4 border rounded"
        oninput="searchItems()" />
      <div id="product-list" class="mt-4"></div>
    </div>
  </div>

  <script>
    const collection = 'product';
    let token = localStorage.getItem('token');
    let allItems = [];

    if (!token) window.location.href = '/admin';

    function jwtDecode(t) {
      try {
        const base64Url = t.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        return JSON.parse(decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
      } catch { return {}; }
    }
    function logout() { localStorage.removeItem('token'); window.location.href = '/admin'; }
    function displayUsername() {
      document.getElementById('username').textContent = jwtDecode(token).username || 'User';
    }

    /* ---------- 模式切換 ---------- */
    function setCreateMode() {
      document.getElementById('form-title').textContent = '新增物品';
      document.getElementById('btn-create').classList.remove('hidden');
      document.getElementById('btn-update').classList.add('hidden');
      document.getElementById('product-id').value = '';
      document.querySelectorAll('#product-name, #product-brand, #product-model, #product-description, #product-price_hkd, #product-category_type, #product-hot')
        .forEach(el => el.value = '');
    }
    function setEditMode(item) {
      document.getElementById('form-title').textContent = '修改物品';
      document.getElementById('btn-create').classList.add('hidden');
      document.getElementById('btn-update').classList.remove('hidden');
      document.getElementById('product-id').value = item._id;
      document.getElementById('product-name').value = item.name;
      document.getElementById('product-brand').value = item.brand;
      document.getElementById('product-model').value = item.model;
      document.getElementById('product-description').value = item.description;
      document.getElementById('product-price_hkd').value = item.price_hkd;
      document.getElementById('product-category_type').value = item.category_type;
      document.getElementById('product-hot').value = item.hot;
    }
    function cancelEdit() { setCreateMode(); }

    /* ---------- 資料操作 ---------- */
    async function loadData() {
      try {
        const res = await fetch(`/${collection}`, { headers: { Authorization: `Bearer ${token}` } });
        if (res.status === 401) return (window.location.href = '/admin');
        allItems = await res.json();
        renderItems(allItems);
      } catch (e) { console.error(e); window.location.href = '/admin'; }
    }
    function renderItems(items) {
      const q = document.getElementById('product-search').value.toLowerCase();
      const filtered = items.filter(i => i.name && i.name.toLowerCase().includes(q));
      const list = document.getElementById('product-list');
      list.innerHTML = '';
      filtered.forEach(i => {
        const div = document.createElement('div');
        div.className = 'bg-white p-4 mb-2 rounded shadow flex justify-between';
        div.innerHTML = `
          <span>${i.name}</span>
          <div>
            <button onclick="editItem('${i._id}')" class="bg-yellow-500 text-white px-2 py-1 rounded mr-2">修改</button>
            <button onclick="if(confirm('確定要刪除這一項嗎？')) deleteItem('${i._id}')" class="bg-red-500 text-white px-2 py-1 rounded">刪除</button>
          </div>`;
        list.appendChild(div);
      });
    }
    function searchItems() { renderItems(allItems); }

    async function editItem(id) {
      const item = allItems.find(i => i._id === id);
      if (item) setEditMode(item);
    }
    async function deleteItem(id) {
      try {
        const res = await fetch(`/${collection}/${id}`, { method: 'DELETE', headers: { Authorization: `Bearer ${token}` } });
        if (res.status === 200) { alert('刪除成功'); loadData(); }
        else alert('刪除失敗');
      } catch (e) { console.error(e); }
    }

    /* ---------- 表單處理 ---------- */
    function getFormData() {
      return {
        name: document.getElementById('product-name').value.trim(),
        brand: document.getElementById('product-brand').value.trim(),
        model: document.getElementById('product-model').value.trim(),
        description: document.getElementById('product-description').value.trim(),
        price_hkd: Number(document.getElementById('product-price_hkd').value),
        category_type: Number(document.getElementById('product-category_type').value),
        hot: Number(document.getElementById('product-hot').value)
      };
    }
    function validateForm() {
      const data = getFormData();
      const ok = Object.values(data).every(v => v !== '' && !Number.isNaN(v));
      if (!ok) alert('請填寫所有必填欄位');
      return ok;
    }
    async function createProduct() {
      if (!validateForm()) return;
      await saveItem(null, getFormData());
      setCreateMode();
    }
    async function updateProduct() {
      const id = document.getElementById('product-id').value;
      if (!id || !validateForm()) return;
      await saveItem(id, getFormData());
      setCreateMode();
    }
    async function saveItem(id, data) {
      try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/${collection}/${id}` : `/${collection}`;
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify(data)
        });
        if (res.status === 200 || res.status === 201) {
          alert(`${id ? '更新' : '建立'}成功`);
          loadData();
        }
        else alert('操作失敗');
      } catch (e) { console.error(e); }
    }

    /* ---------- 初始 ---------- */
    window.onload = () => { displayUsername(); loadData(); };
  </script>
</body>

</html>