<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理問答</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-4">
    <!-- Header with Username and Logout -->
    <div class="flex justify-between items-center mb-6">
      <a href="/admin" class="bg-blue-500 text-white p-4 rounded text-center hover:bg-blue-600">← 後退</a>
      <h1 class="text-3xl font-bold">問答管理</h1>
      <div class="flex items-center space-x-4">
        <span id="username" class="text-lg font-semibold"></span>
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">登出賬戶</button>
      </div>
    </div>


    <!-- Question Form -->
    <div class="bg-white p-6 rounded shadow-md mb-8">
      <h2 id="form-title" class="text-2xl font-semibold mb-4">新增問答</h2>
      <input id="question-id" type="hidden">
      <input id="question-question" type="text" placeholder="Question" class="w-full p-2 mb-2 border rounded"
        required />
      <input id="question-answer" type="text" placeholder="Answer" class="w-full p-2 mb-2 border rounded" required />
      <div class="flex space-x-4">
        <button id="btn-create" onclick="createProduct()"
          class="flex-1 bg-green-500 text-white p-2 rounded hover:bg-green-600">建立</button>
        <button id="btn-update" onclick="updateProduct()"
          class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 hidden">確認修改</button>
        <button onclick="cancelEdit()" class="flex-1 bg-gray-400 text-white p-2 rounded hover:bg-gray-500">取消</button>
      </div>

    </div>

    <!-- Search and Question List -->
    <div class="mb-8">
      <h2 class="text-2xl font-semibold mb-4">列表</h2>
      <input id="question-search" type="text" placeholder="請輸入想搜尋的關鍵字" class="w-full p-2 mb-4 border rounded"
        oninput="searchItems()">
      <div id="question-list" class="mt-4"></div>
    </div>
  </div>

  <script>
    const collection = 'question';
    let token = localStorage.getItem('token');
    let allItems = []; // Store all fetched items

    // Redirect to login if no token
    if (!token) {
      window.location.href = '/admin';
    }

    // JWT decode function
    function jwtDecode(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return {};
      }
    }

    // Logout function
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/admin';
    }
    /* ---------- 模式切換 ---------- */
    function setCreateMode() {
      document.getElementById('form-title').textContent = '新增問答';
      document.getElementById('btn-create').classList.remove('hidden');
      document.getElementById('btn-update').classList.add('hidden');
      document.getElementById('question-id').value = '';
      // document.getElementById('question-question').value = '';
      // document.getElementById('question-answer').value = '';
      document.querySelectorAll('#question-question, #question-answer')
        .forEach(el => el.value = '');
    }
    function setEditMode(item) {
      document.getElementById('form-title').textContent = '修改問答';
      document.getElementById('btn-create').classList.add('hidden');
      document.getElementById('btn-update').classList.remove('hidden');
      document.getElementById('question-id').value = item._id;
      document.getElementById('question-question').value = item.question;
      document.getElementById('question-answer').value = item.answer;
    }
    function cancelEdit() { setCreateMode(); }

    function displayUsername() {
      const decoded = jwtDecode(token);
      const usernameElement = document.getElementById('username');
      usernameElement.textContent = decoded.username || 'User';
    }

    // Load data
    async function loadData() {
      try {
        const response = await fetch(`/${collection}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.status === 401) {
          window.location.href = '/admin';
          return;
        }
        allItems = await response.json();
        renderItems(allItems);
      } catch (error) {
        console.error(`Error loading ${collection}:`, error);
        window.location.href = '/admin';
      }
    }

    // Render items (limited to 15, filtered by search)
    function renderItems(items) {
      const searchQuery = document.getElementById(`${collection}-search`).value.toLowerCase();
      const filteredItems = items.filter(item =>
        item.question && item.question.toLowerCase().includes(searchQuery)
      )
      const list = document.getElementById(`${collection}-list`);
      list.innerHTML = '';
      filteredItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'bg-white p-4 mb-2 rounded shadow flex justify-between';
        div.innerHTML = `
          <span>${item.question}</span>
          <div>
            <button onclick="editItem('${item._id}')" class="bg-yellow-500 text-white px-2 py-1 rounded mr-2">修改</button>
            <button onclick="if(confirm('確定要刪除這一項嗎？')) deleteItem('${item._id}')" class="bg-red-500 text-white px-2 py-1 rounded">刪除</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    // Search items
    function searchItems() {
      renderItems(allItems);
    }

    // Edit item
    async function editItem(id) {
      try {
        const item = allItems.find(i => i._id === id);
        if (item) {
          setEditMode(item);
          document.getElementById(`${collection}-id`).value = id;
          Object.keys(item).forEach(key => {
            if (key !== '_id') {
              const input = document.getElementById(`${collection}-${key}`);
              if (input)
                input.value = item[key];
            }
          });
        }
      } catch (error) {
        console.error(`Error editing ${collection}:`, error);
      }
    }

    // Delete item
    async function deleteItem(id) {
      try {
        const response = await fetch(`/${collection}/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.status === 200) { alert('刪除成功'); loadData(); }
        else
          alert('刪除失敗');
      } catch (error) {
        console.error(`Error deleting ${collection}:`, error);
      }
    }
    /* ---------- 表單處理 ---------- */
    function getFormData() {
      return {
        question: document.getElementById('question-question').value.trim(),
        answer: document.getElementById('question-answer').value.trim(),
      };
    }
    function validateForm() {
      const data = getFormData();
      const ok = Object.values(data).every(v => v !== '' && !Number.isNaN(v));
      if (!ok) alert('請填寫所有必填欄位');
      return ok;
    }
    async function createProduct() {
      if (!validateForm()) return;
      await saveItem(null, getFormData());
      setCreateMode();
    }
    async function updateProduct() {
      const id = document.getElementById('question-id').value;
      if (!id || !validateForm()) return;
      await saveItem(id, getFormData());
      setCreateMode();
    }

    // Save question
    // async function saveQuestion() {
    //   const id = document.getElementById('question-id').value;
    //   const data = {

    //     question: document.getElementById('question-question').value,
    //     answer: document.getElementById('question-answer').value
    //   };
    //   saveItem(id, data);
    // }

    // Generic save function
    async function saveItem(id, data) {
      try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/${collection}/${id}` : `/${collection}`;
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        if (response.status === 201 || response.status === 200) {
          alert(`問答已${id ? '更新' : '建立'}`);
          loadData();
          document.querySelectorAll(`#${collection}-form input, #${collection}-form textarea`).forEach(input => input.value = '');
          document.getElementById(`${collection}-id`).value = '';
        } else {
          alert(`錯誤 ${id ? '更新' : '建立'} `);
        }
      } catch (error) {
        console.error(`Error saving ${collection}:`, error);
      }
    }

    // Load data and username on page load
    window.onload = () => {
      displayUsername();
      loadData();
    };
  </script>
</body>

</html>